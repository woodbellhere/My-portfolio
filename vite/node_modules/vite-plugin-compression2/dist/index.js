"use strict";Object.defineProperty(exports, "__esModule", {value: true}); function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }var Q=Object.create;var F=Object.defineProperty;var W=Object.getOwnPropertyDescriptor;var X=Object.getOwnPropertyNames;var J=Object.getPrototypeOf,K=Object.prototype.hasOwnProperty;var N=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var $=(t,e,o,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of X(e))!K.call(t,i)&&i!==o&&F(t,i,{get:()=>e[i],enumerable:!(r=W(e,i))||r.enumerable});return t};var H=(t,e,o)=>(o=t!=null?Q(J(t)):{},$(e||!t||!t.__esModule?F(o,"default",{value:t,enumerable:!0}):o,t));var U=N((xt,b)=>{"use strict";var{bind:et,call:rt}=Function.prototype,ot=et.bind(rt);b.exports.uncurryThis=ot;var it=Object.getPrototypeOf(Uint8Array.prototype);b.exports.TypedArrayPrototype=it;var nt=(t,e,o,r)=>{if(e in t){if(r===!0){if(t[e]===o)return}else if(!(typeof r=="function"&&Object.prototype.toString.call(r)==="[object Function]")||!r())return}Object.defineProperty(t,e,{configurable:!0,enumerable:!1,value:o,writable:!0})},L=(t,e,o={})=>{let r=Array.prototype.concat.call(Object.keys(e),Object.getOwnPropertySymbols(e));for(let i=0,n=r.length;i<n;i++)nt(t,r[i],e[r[i]],o[r[i]])};b.exports.defineProperties=L;var st=(t,e)=>L(t,{implementation:e,getPolyfill:()=>e,shim:()=>e});b.exports.makeEsShim=st});var D=N((Et,z)=>{"use strict";var{makeEsShim:ut}=U(),q=typeof AggregateError=="function"?AggregateError:(()=>{function t(e,o){let r=new Error(o);return Object.setPrototypeOf(r,t.prototype),delete r.constructor,Object.defineProperty(r,"errors",{value:Array.from(e)}),r}return Object.defineProperty(t,"prototype",{writable:!1}),Object.defineProperties(t.prototype,{constructor:{enumerable:!1,configurable:!0,writable:!0,value:t},message:{enumerable:!1,configurable:!0,writable:!0,value:""},name:{enumerable:!1,configurable:!0,writable:!0,value:"AggregateError"}}),Object.setPrototypeOf(t.prototype,Error.prototype),t})(),V=q;ut(V,q);z.exports=V});var _promises = require('fs/promises'); var _promises2 = _interopRequireDefault(_promises);var _fs = require('fs'); var _fs2 = _interopRequireDefault(_fs);var _os = require('os'); var _os2 = _interopRequireDefault(_os);var _path = require('path'); var _path2 = _interopRequireDefault(_path);var _pluginutils = require('@rollup/pluginutils');function c(t){return t.length}function E(t,e){let o=typeof e=="function"?e(t):e,{dir:r,base:i}=_path2.default.parse(t),n=r?r+"/":"";return o.replace(/\[path\]/,n).replace(/\[base\]/,i)}function T(t){return/^\\\\\?\\/.test(t)?t:t.replace(/\\/g,"/")}async function I(t){let e=await Promise.all((await _promises2.default.readdir(t)).map(i=>_path2.default.join(t,i))),o=0,r=[];for(;o!==c(e);){let i=e[o],n=await _promises2.default.stat(i);if(n.isDirectory()){let P=await _promises2.default.readdir(i);e.push(...P.map(O=>_path2.default.join(i,O)))}n.isFile()&&r.push(i),o++}return r}var _zlib = require('zlib'); var _zlib2 = _interopRequireDefault(_zlib);var _util = require('util'); var _util2 = _interopRequireDefault(_util);function R(t){let e=t in _zlib2.default?t:"gzip";return{algorithm:_util2.default.promisify(_zlib2.default[e])}}async function j(t,e,o){try{let r=await e(t,o);return Buffer.isBuffer(r)?r:Buffer.from(r)}catch(r){return Promise.reject(r)}}var k={gzip:{level:_zlib2.default.constants.Z_BEST_COMPRESSION},brotliCompress:{params:{[_zlib2.default.constants.BROTLI_PARAM_QUALITY]:_zlib2.default.constants.BROTLI_MAX_QUALITY}},deflate:{level:_zlib2.default.constants.Z_BEST_COMPRESSION},deflateRaw:{level:_zlib2.default.constants.Z_BEST_COMPRESSION}};var M=H(D());var B=class{constructor(e){this.maxConcurrent=e,this.queue=[],this.errors=[],this.running=0}enqueue(e){this.queue.push(e),this.run()}async run(){for(;this.running<this.maxConcurrent&&this.queue.length;){let e=this.queue.shift();this.running++;try{await e()}catch(o){this.errors.push(o)}finally{this.running--,this.run()}}}async wait(){for(;this.running;)await new Promise(e=>setTimeout(e,0));if(c(this.errors))throw new M.default(this.errors,"task failed")}};function G(t){return new B(t)}var ct="vite:build-import-analysis",mt="copyPublicDir",ft=(()=>{let t=_os2.default.cpus()||{length:1};return t.length===1?10:Math.max(1,t.length-1)})();function gt(t){var r;let e=new Set,o=(i,n)=>T(_path2.default.resolve(i,n));return(r=t.build.rollupOptions)!=null&&r.output?(Array.isArray(t.build.rollupOptions.output)?t.build.rollupOptions.output:[t.build.rollupOptions.output]).forEach(n=>{typeof n=="object"&&!c(Object.keys(n))||e.add(o(t.root,n.dir||t.build.outDir))}):e.add(o(t.root,t.build.outDir)),e}async function ht(t,e){let o=t.generateBundle;if(typeof o=="object"&&o.handler){let r=o.handler;o.handler=async function(...i){await r.apply(this,i),await e.apply(this,i)}}typeof o=="function"&&(t.generateBundle=async function(...r){await o.apply(this,r),await e.apply(this,r)})}function yt(t={}){let{include:e,exclude:o,threshold:r=0,algorithm:i="gzip",filename:n,compressionOptions:P,deleteOriginalAssets:O=!1,skipIfLargerOrEqual:v=!0}=t,S=_pluginutils.createFilter.call(void 0, e,o),_=[],l=Object.create(null);l.algorithm=typeof i=="string"?R(i).algorithm:i,l.options=typeof i=="function"?P:Object.assign(k[i],P),l.filename=n!=null?n:i==="brotliCompress"?"[path][base].br":"[path][base].gz";let A=G(ft),Z=async function(s,f){for(let u in f){if(!S(u))continue;let a=f[u],p=a.type==="asset"?a.source:a.code,g=c(p);g<r||A.enqueue(async()=>{let m=E(u,l.filename),h=await j(Buffer.from(p),l.algorithm,l.options);v&&c(h)>=g||((O||u===m)&&Reflect.deleteProperty(f,u),this.emitFile({type:"asset",fileName:m,source:h}))})}await A.wait().catch(this.error)};return{name:"vite-plugin-compression",apply:"build",enforce:"post",async configResolved(s){let f=gt(s),u=mt in s.build?s.build.copyPublicDir:!0;if(s.publicDir&&u&&_fs2.default.existsSync(s.publicDir)){let p=await I(s.publicDir),g=_path2.default.join(s.root,_path2.default.relative(s.root,s.publicDir));Promise.all(p.map(async m=>{if(!S(m))return;let{size:h}=await _promises2.default.stat(m);if(h<r)return;let Y=T(_path2.default.relative(g,m));_.push({file:Y,dests:[...f]})}))}let a=s.plugins.find(p=>p.name===ct);if(!a)throw new Error("vite-plugin-compression can't be work in versions lower than vite2.0.0");ht(a,Z)},async closeBundle(){_.forEach(({file:s,dests:f})=>A.enqueue(async()=>{await Promise.all(f.map(async u=>{let a=_path2.default.join(u,s),p=await _promises2.default.readFile(a),g=await j(p,l.algorithm,l.options);if(v&&c(g)>=c(p))return;let m=E(s,l.filename),h=_path2.default.join(u,m);O&&h!==a&&await _promises2.default.rm(a,{recursive:!0,force:!0}),await _promises2.default.writeFile(h,g)}))})),await A.wait().catch(s=>s)}}}var kt=yt;exports.compression = yt; exports.default = kt;
